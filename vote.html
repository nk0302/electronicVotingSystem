<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æŠ•ç¥¨</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <p class="instruction">æŠ•ç¥¨ç”¨ç´™ã‚’æŠ•ç¥¨ç®±ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„</p>

    <div id="ballotBox" class="ballot-box">
      ğŸ—³ï¸
      <div class="box-text">æŠ•ç¥¨ç®±</div>
    </div>

    <div class="ballots">
      <img src="ballot1.png" class="ballot" draggable="true" data-value="A" alt="å®‰è—¤è·¯çœŸ">
      <img src="ballot2.png" class="ballot" draggable="true" data-value="B" alt="åŠ è—¤ãã‚‰">
      <img src="ballot3.png" class="ballot" draggable="true" data-value="C" alt="ä¸­åŸåšå²">
    </div>

    <div class="vote-message" id="voteMessage"></div>
  </div>

  <div class="modal hidden" id="confirmModal">
    <div class="modal-content">
      <p id="confirmText"></p>
      <div class="modal-buttons">
        <button id="confirmYes">æŠ•ç¥¨ã™ã‚‹</button>
        <button id="confirmNo" class="cancel">æŠ•ç¥¨ã—ãªã„</button>
      </div>
    </div>
  </div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { ref, set, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* ===== èªè¨¼ãƒã‚§ãƒƒã‚¯ & æŠ•ç¥¨æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ ===== */
onAuthStateChanged(auth, async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  const voteRef = ref(db, "votes/" + user.uid);
  const snapshot = await get(voteRef);
  if (snapshot.exists()) {
    alert("ã‚ãªãŸã¯æ—¢ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™");
    location.href = "alreadyVoted.html";
  }
});

const ballotsContainer = document.querySelector(".ballots");
const ballots = Array.from(ballotsContainer.children);

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

shuffle(ballots);

ballotsContainer.innerHTML = "";
ballots.forEach(b => ballotsContainer.appendChild(b));

/* ===== çŠ¶æ…‹ ===== */
let selectedVote = null;

/* ===== ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç† ===== */
document.querySelectorAll(".ballot").forEach(ballot => {
  ballot.addEventListener("dragstart", () => {
    selectedVote = ballot.alt;
    ballot.classList.add("dragging");
  });

  ballot.addEventListener("dragend", () => {
    ballot.classList.remove("dragging");
  });
});

/* ===== æŠ•ç¥¨ç®± ===== */
const box = document.getElementById("ballotBox");
const modal = document.getElementById("confirmModal");
const confirmText = document.getElementById("confirmText");
const messageEl = document.getElementById("voteMessage");

box.addEventListener("dragover", e => {
  e.preventDefault();
  box.classList.add("hover");
});

box.addEventListener("dragleave", () => {
  box.classList.remove("hover");
});

box.addEventListener("drop", e => {
  e.preventDefault();
  box.classList.remove("hover");
  if (!selectedVote) return;

  confirmText.innerHTML = `${selectedVote}ã•ã‚“ã«æŠ•ç¥¨ã—ã¾ã™ã€‚<br>ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
  modal.classList.remove("hidden");
});

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ===== */
document.getElementById("confirmNo").onclick = () => {
  modal.classList.add("hidden");
  selectedVote = null;
};

document.getElementById("confirmYes").onclick = async () => {
  try {
    const uid = auth.currentUser.uid;

    // é¸æŠã—ãŸ ballot è¦ç´ ã‚’å–å¾—ï¼ˆaltåã§ä¸€è‡´ï¼‰
    const ballotEl = [...document.querySelectorAll(".ballot")]
      .find(b => b.alt === selectedVote);

    if (ballotEl) {
      ballotEl.style.transition = "all 0.6s ease";
      ballotEl.style.transform = "translateY(-200px) scale(0.2)";
      ballotEl.style.opacity = "0.5";
    }

    await set(ref(db, "votes/" + uid), {
      choice: selectedVote,
      votedAt: serverTimestamp()
    });

    setTimeout(() => {
      location.href = "complete.html";
    }, 700);

  } catch (e) {
    modal.classList.add("hidden");
    messageEl.textContent = "æŠ•ç¥¨ã«å¤±æ•—ã—ã¾ã—ãŸ";
    messageEl.classList.add("error");
  }
};
</script>
</body>
</html>
